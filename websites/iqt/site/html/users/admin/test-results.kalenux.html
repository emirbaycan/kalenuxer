<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Results - IQ Test Platform</title>
    <link rel="stylesheet" href="/css/users/admin/general.css">
    <link rel="stylesheet" href="/css/users/admin/test-results.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>

<body>
    <div class="admin-container">
        !panel_menu!

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <div class="header-left">
                    <h1><i class="fas fa-chart-line"></i> Test Results</h1>
                    <p><i class="fas fa-brain"></i> View and analyze IQ test results from users</p>
                </div>
                <div class="header-right">
                    <div class="header-actions">
                        <button class="header-action-btn" title="Notifications">
                            <i class="fas fa-bell"></i>
                            <span class="badge">3</span>
                        </button>
                        <button class="header-action-btn" title="Messages">
                            <i class="fas fa-envelope"></i>
                            <span class="badge">5</span>
                        </button>
                        <button class="header-action-btn" title="Settings">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                    <div class="admin-profile">
                        <div class="admin-profile-info">
                            <span>Admin User</span>
                            <small>Administrator</small>
                        </div>
                        <i class="fas fa-user-circle"></i>
                        <div class="status-indicator"></div>
                        
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown">
                            <div class="dropdown-header">
                                <div class="dropdown-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="dropdown-name">Admin User</div>
                                <div class="dropdown-email">admin@whats-your-iq.com</div>
                            </div>
                            <div class="dropdown-menu">
                                <a href="/users/admin/profile" class="dropdown-item">
                                    <i class="fas fa-user"></i>
                                    <span>My Profile</span>
                                </a>
                                <a href="/users/admin/settings" class="dropdown-item">
                                    <i class="fas fa-cog"></i>
                                    <span>Account Settings</span>
                                </a>
                                <a href="/users/admin/preferences" class="dropdown-item">
                                    <i class="fas fa-palette"></i>
                                    <span>Preferences</span>
                                </a>
                                <div class="dropdown-divider"></div>
                                <a href="/users/admin/help" class="dropdown-item">
                                    <i class="fas fa-question-circle"></i>
                                    <span>Help & Support</span>
                                </a>
                                <a href="/users/admin/activity" class="dropdown-item">
                                    <i class="fas fa-history"></i>
                                    <span>Activity Log</span>
                                </a>
                                <div class="dropdown-divider"></div>
                                <a href="#" id="logout-btn-header" class="dropdown-item danger">
                                    <i class="fas fa-sign-out-alt"></i>
                                    <span>Sign Out</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div class="admin-main-content">
                <!-- Stats Section -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-content">
                            <div>
                                <h3 id="total-tests">0</h3>
                                <p>Total Tests</p>
                            </div>
                            <i class="fas fa-clipboard-list stat-icon"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div>
                                <h3 id="completed-tests">0</h3>
                                <p>Completed</p>
                            </div>
                            <i class="fas fa-check-circle stat-icon"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div>
                                <h3 id="avg-score">0</h3>
                                <p>Average IQ Score</p>
                            </div>
                            <i class="fas fa-star stat-icon"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-content">
                            <div>
                                <h3 id="today-tests">0</h3>
                                <p>Tests Today</p>
                            </div>
                            <i class="fas fa-calendar-day stat-icon"></i>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-bar"></i> Score Distribution</h3>
                            <button class="btn btn-outline btn-sm" onclick="refreshCharts()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="score-distribution-chart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3><i class="fas fa-chart-line"></i> Tests Over Time</h3>
                            <select id="time-range-filter" class="form-control form-control-sm" onchange="updateTimeChart()">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="tests-over-time-chart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="filters-section">
                    <div class="filters-row">
                        <div class="filter-group">
                            <label>Search</label>
                            <input type="text" id="search-filter" placeholder="Email or Session ID..." class="form-control" onkeyup="debounceFilter()">
                        </div>
                        <div class="filter-group">
                            <label>Test Type</label>
                            <select id="test-type-filter" class="form-control" onchange="applyFilters()">
                                <option value="">All Types</option>
                                <option value="full">Full Test</option>
                                <option value="quick">Quick Test</option>
                                <option value="practice">Practice</option>
                                <option value="timed">Timed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Status</label>
                            <select id="status-filter" class="form-control" onchange="applyFilters()">
                                <option value="">All Status</option>
                                <option value="completed">Completed</option>
                                <option value="abandoned">Abandoned</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Payment Status</label>
                            <select id="payment-filter" class="form-control" onchange="applyFilters()">
                                <option value="">All</option>
                                <option value="paid">Paid</option>
                                <option value="pending">Pending</option>
                                <option value="failed">Failed</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Date Range</label>
                            <input type="date" id="date-from" class="form-control" onchange="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <input type="date" id="date-to" class="form-control" onchange="applyFilters()">
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-outline" onclick="clearFilters()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Test Results Table -->
                <div class="table-section">
                    <div class="table-header">
                        <h3><i class="fas fa-list"></i> Test Results</h3>
                        <div class="table-actions">
                            <button class="btn btn-outline" onclick="exportResults()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                            <button class="btn btn-primary" onclick="loadTestResults()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="results-table" class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Email</th>
                                    <th>Test Type</th>
                                    <th>IQ Score</th>
                                    <th>Percentile</th>
                                    <th>Accuracy</th>
                                    <th>Duration</th>
                                    <th>Status</th>
                                    <th>Payment</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="results-tbody">
                                <tr class="loading-row">
                                    <td colspan="11" style="text-align: center; padding: 2rem;">
                                        <div class="spinner" style="margin: 0 auto;"></div>
                                        <p style="margin-top: 1rem; color: var(--text-secondary);">Loading test results...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination" id="pagination">
                        <button class="pagination-btn" onclick="changePage(-1)">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span id="page-info">Page 1 of 1</span>
                        <button class="pagination-btn" onclick="changePage(1)">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div><!-- /.admin-main-content -->
        </main>
    </div>

    <!-- View Details Modal -->
    <div class="modal" id="view_details_modal">
        <div class="modal-dialog modal-large">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-info-circle"></i> Test Result Details</h3>
                    <button class="modal-close" onclick="closeModal('view_details_modal')">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="details-content">
                        <!-- Populated dynamically -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeModal('view_details_modal')">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="/js/users/admin/admin-common.js"></script>
    <script src="/js/users/admin/test-results.js"></script>
    <script>
        // Wrapper functions to maintain onclick compatibility
        function refreshCharts() { testResultsManager.refreshCharts(); }
        function clearFilters() { testResultsManager.clearFilters(); }
        function exportResults() { testResultsManager.exportResults(); }
        function loadTestResults() { testResultsManager.loadTestResults(); }
        function changePage(delta) { testResultsManager.changePage(delta); }
        function closeModal(modalId) { testResultsManager.closeModal(modalId); }
        function viewDetails(id) { testResultsManager.viewDetails(id); }
        function downloadReport(id) { testResultsManager.downloadReport(id); }
        function deleteResult(id) { testResultsManager.deleteResult(id); }
    </script>
</body>
</html>
