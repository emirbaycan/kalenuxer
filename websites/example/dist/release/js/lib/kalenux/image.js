function kalenuxImage(e){var a,t,n,i,l,d=document.createElement("div");for(i in d.className="kalenux-image-adder",(t=document.createElement("input")).className=e.className.replace("kalenux-images","kalenux-image"),e.id&&(t.id=e.id),n=Object.keys(e.dataset))l=n[i],t.dataset[l]=e.dataset[l];t.type="hidden",t.dataset.type="image",(n=document.createElement("div")).className="kalenux-image-add",(i=document.createElement("input")).className="kalenux-image-input",i.type="file",i.onchange=kalenuxImageSelected.bind(),(l=document.createElement("div")).className="kalenux-image-display",e.dataset.default&&(l.style="background-image:url("+e.dataset.default+")",delete e.dataset.default),a=e.parentNode,d.appendChild(n),d.appendChild(i),a.appendChild(d),a.appendChild(t),a.appendChild(l),-1!=e.className.indexOf("kalenux-change")&&(t.className="kalenux-image kalenux-change"),e.remove()}function kalenuxVideo(e){var a,t,n,i,l,d=document.createElement("div");for(i in d.className="kalenux-video-adder",(t=document.createElement("input")).className=e.className.replace("kalenux-videos","kalenux-video"),e.id&&(t.id=e.id),n=Object.keys(e.dataset))l=n[i],t.dataset[l]=e.dataset[l];t.type="hidden",t.dataset.type="video",(n=document.createElement("div")).className="kalenux-video-add",(i=document.createElement("input")).className="kalenux-video-input",i.type="file",i.onchange=kalenuxVideoSelected.bind(),(l=document.createElement("video")).className="kalenux-video-display",l.controls=!0,e.dataset.default&&(l.src=e.dataset.default,delete e.dataset.default),a=e.parentNode,d.appendChild(n),d.appendChild(i),a.appendChild(d),a.appendChild(t),a.appendChild(l),-1!=e.className.indexOf("kalenux-change")&&(t.className="kalenux-video kalenux-change"),e.remove()}function onKalenuxVideoeUploaded(e){e.previousElementSibling.src=e.dataset.folder+user_id,e.previousElementSibling.load()}function onKalenuxImageUploaded(e){e.previousElementSibling.setAttribute("style","background-image:url("+e.dataset.folder+user_id+")")}function kalenuxVideoSelected(event){var a,b,c,d,data,url,a=event.target,b=a.files[0];a=a.parentNode.nextElementSibling,c=b.type.split("/")[1],d=a.dataset.api,url=eval(d+"_api_url"),data=new FormData,data.append("file",b),a.dataset.page&&data.append("page",a.dataset.page),postForm(url+a.dataset.upload,function(e,a){1===e.result&&((e=a.elem).nextElementSibling.src=e.dataset.folder+user_id+"."+a.type+"?"+(new Date).getTime(),e.nextElementSibling.load(),e.value=1,setChanged(e))},data,{elem:a,type:c})}function kalenuxImageSelected(event){var a,b,c,d,data,data,a=event.target,b=a.files[0];a=a.parentNode.nextElementSibling,c=b.type.split("/")[1],d=a.dataset.api,api_url=eval(d+"_api_url"),a.dataset.compress?kalenuxCompress(function(e,a){var t=new FormData;t.append("file",e),c=e.type.split(".")[1],a.dataset.page&&t.append("page",a.dataset.page),postForm(api_url+a.dataset.upload,function(e,a){1===e.result&&((e=a.elem).nextElementSibling.setAttribute("style","background-image:url("+e.dataset.folder+user_id+"."+a.type+"?"+(new Date).getTime()+")"),e.value=1,setChanged(e))},t,{elem:a,type:c})},b,a):(data=new FormData,data.append("file",b),a.dataset.page&&data.append("page",a.dataset.page),postForm(api_url+a.dataset.upload,function(e,a){1===e.result&&((e=a.elem).nextElementSibling.setAttribute("style","background-image:url("+e.dataset.folder+user_id+"."+a.type+"?"+(new Date).getTime()+")"),e.value=1,setChanged(e))},data,{elem:a,type:c}))}function kalenuxSetVideo(e,a){(e=document.getElementById(e)).value=0,e.nextElementSibling.src=a+"?"+(new Date).getTime(),e.nextElementSibling.load()}function kalenuxSetImage(e,a){(e=document.getElementById(e)).value=0,e.nextElementSibling.setAttribute("style","background-image:url("+a+"?"+(new Date).getTime()+")")}function kalenuxCompressImage(e,a,t,n,i,l,d,r,s,u,o){var m,p,c,g=t.width,f=t.height;for(e<g&&(f=Math.round(e*f/g),g=e);;){if(m=(p=document.createElement("canvas")).getContext("2d"),0<r)switch(-1<[5,6,7,8].indexOf(r)?(p.width=f,p.height=g):(p.width=g,p.height=f),r){case 2:m.transform(-1,0,0,1,g,0);break;case 3:m.transform(-1,0,0,-1,g,f);break;case 4:m.transform(1,0,0,-1,0,f);break;case 5:m.transform(0,1,1,0,0,0);break;case 6:m.transform(0,1,-1,0,f,0);break;case 7:m.transform(0,-1,-1,0,f,g);break;case 8:m.transform(0,-1,1,0,0,g)}else p.width=g,p.height=f;if(m.fillStyle=l,m.fillRect(0,0,g,f),m.drawImage(t,0,0,g,f),void 0!==o&&(m.font="600 30px Arial",m.textAlign="center",m.fillStyle="rgba(255, 255, 255, 0.1)",m.fillText(o,g/2,f/2)),(c=7*(p=p.toDataURL(n,d)).length/8)<i&&c<s)return p;if((d-=u)<=0)return p}}function kalenuxGetOrientation(s,e){var a=new FileReader;a.onload=function(e){var a=new DataView(e.target.result);if(65496!=a.getUint16(0,!1))return s(-2);for(var t=a.byteLength,n=2;n<t;){var i=a.getUint16(n,!1);if(n+=2,65505==i){if(1165519206!=a.getUint32(n+=2,!1))return s(-1);var l=18761==a.getUint16(n+=6,!1),d=(n+=a.getUint32(n+4,l),a.getUint16(n,l));n+=2;for(var r=0;r<d;r++)if(274==a.getUint16(n+12*r,l))return s(a.getUint16(n+12*r+8,l))}else{if(65280!=(65280&i))break;n+=a.getUint16(n,!1)}}return s(-1)},a.readAsArrayBuffer(e.slice(0,65536))}function kalenuxSrcToFile(e,a,t){return fetch(e).then(function(e){return e.arrayBuffer()}).then(function(e){return new File([e],t,{type:a})})}function kalenuxCompress(o,m,p){var e;"undefined"!=typeof FileReader&&((e=new FileReader).onload=function(e){var a,t,n,i=e.target.result,l=p.dataset.maxSize?parseInt(p.dataset.maxSize):1048576,d=p.dataset.minSize?parseInt(p.dataset.minSize):209715.2,r=p.dataset.maxWidth?parseInt(p.dataset.maxWidth):1920,s=p.dataset.maxHeight?parseInt(p.dataset.maxHeight):1080,u=p.dataset.fillStyle||"rgba(0, 0, 0, 0)";p.dataset.logo&&(n=p.dataset.logo),a=new Image,t=m.size,kalenuxGetOrientation(function(e){imgType=d<t?"image/jpeg":m.type,fileType=imgType.split("/")[1],a.onload=function(){kalenuxSrcToFile(i=kalenuxCompressImage(r,s,a,imgType,l,u,.9,e,t,.1,n),"image."+imgType.split("/")[1],"file."+fileType).then(function(e){o(e,p)})},a.src=i},m)},e.readAsDataURL(m))}firer.push(function(){setElems("kalenux-images",kalenuxImage),setElems("kalenux-videos",kalenuxVideo)});