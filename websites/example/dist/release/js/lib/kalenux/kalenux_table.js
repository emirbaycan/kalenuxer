function setTemplates(){for(var e,t,a,s,l,n,d=document.getElementsByTagName("kalenux-template"),i=d.length,c=0;c<i;c++)if(e=d[c])if(t=e.id,tables[t]||(tables[t]={}),e.dataset.types)for(s=(a=e.dataset.types.split(",")).length,tables[t].template_type=e.dataset.type,tables[t].template={},e=e.innerHTML,l=0;l<s;l++)n=a[l].toString(),tables[t].template[n]=e.substring(e.indexOf("<t_"+n+">")+n.length+4,e.indexOf("</t_"+n+">"));else tables[t].template=e.innerHTML}function setNavs(e){var t,a,s,l,n,d,i,c,r,o=Math.ceil(e.count/e.limit);for(e.start>e.count?e.navs.parentNode.dataset.status="last":e.navs.parentNode.dataset.status="",l=(n=e.page)+5,d=n-5,(a=e.navs.parentNode).innerHTML="",i=(c=table_texts).nav_order,s=-1;-2<=s;s--)(t=document.createElement("button")).className="ktn-item ktn-part",t.innerHTML=c[i[s]],t.onclick=setNav.bind(null,s,e),a.appendChild(t);for((t=document.createElement("div")).className="ktn-part ktn-parts",a.appendChild(t),e.navs=t,s=-3;-4<=s;s--)(t=document.createElement("button")).className="ktn-item ktn-part",t.innerHTML=c[i[s]],t.onclick=setNav.bind(null,s,e),a.appendChild(t);for(s=1;s<=o;s++)l<s&&s!==o||s<d&&1!==s||(a=document.createElement("button"),s==n?(r=!0,e.navs.parentNode.dataset.page=s!=o?s:-1):r=!1,a.className="ktn-item "+(r?"active":""),a.innerHTML=s,a.onclick=setNav.bind(null,s,e),e.navs.appendChild(a))}function startKalenux(){tables={},"undefined"==typeof table_texts&&(table_texts={nav_order:{"-1":"first","-2":"prev","-3":"next","-4":"last"},first:"@first@",prev:"@prev@",next:"@next@",last:"@last@"}),setTemplates(),setTables()}function adjustWidths(){if(tables)for(table in tables)(table=tables[table])&&adjustWidth(table)}function setWidths(e){for(var t,a,s,l,n=e.table.getElementsByClassName("kt-cell"),d=n.length,i=0;i<d;i++)for(a=(t=n[i].getElementsByClassName("kt-item")).length,l=0;l<a;l++)s=t[l],(!e.widths[l]||e.widths[l]<s.offsetWidth)&&(e.widths[l]=s.offsetWidth)}function openHandlers(e,t){var a,s,l;if(t.classList.contains("icon-plus")){for(t.classList.remove("icon-plus"),t.classList.add("icon-minus"),s=(a=e.table.getElementsByClassName("kt-handle")).length,l=0;l<s;l++)openHandler(d=a[l]);t.parentNode.dataset.state="open"}else{for(t.classList.remove("icon-minus"),t.classList.add("icon-plus"),s=(a=e.table.getElementsByClassName("kt-handle")).length,l=0;l<s;l++)closeHandler(d=a[l]);t.parentNode.dataset.state=""}}function changeHandler(e){(e.classList.contains("icon-plus")?openHandler:closeHandler)(e)}function getMinWidth(e){var t=document.createElement("div");return t.className="kt-check-width",t.style.width="auto",t.style.position="absolute",t.style.right="-1000px",t.style.whiteSpace="nowrap",t.innerHTML=e.outerHTML,document.body.appendChild(t),r=t.firstElementChild.offsetWidth,document.body.removeChild(t),r}function openHandler(e){if(e.classList.remove("icon-plus"),e.classList.add("icon-minus"),e.parentNode.parentNode.dataset.state="open",!e.dataset.widthed){var t,a,s,l,n;for(e.dataset.widthed=!0,a=(t=e.parentNode.parentNode.lastElementChild.getElementsByClassName("kt-handler-head")).length,n=s=0;n<a;n++)s<(l=getMinWidth(t[n]))&&(s=l);for(n=0;n<a;n++)t[n].style.width=s+"px"}}function closeHandler(e){e.classList.remove("icon-minus"),e.classList.add("icon-plus"),e.parentNode.parentNode.dataset.state=""}function adjustWidth(e){var t,a,s,l,n,d,i,c,r=e.table,o=e.widths,m=o.length,p=0,h=r.offsetWidth;for(r.getElementsByClassName("kt-handle").length&&(h-=r.getElementsByClassName("kt-handle")[0].offsetWidth),d=0;d<m;d++)p+=o[d];for(;h<p;)p-=o[--m];for(a=(t=r.getElementsByClassName("kt-cell")).length,d=0;d<a;d++){for(n=(l=(s=t[d]).getElementsByClassName("kt-item")).length,deactivate=!1,i=0;i<n;i++)(h=l[i]).style.minWidth=o[i]+"px",i<m?!0===h.classList.contains("kt-deactive")&&h.classList.remove("kt-deactive"):(!1===h.classList.contains("kt-deactive")&&h.classList.add("kt-deactive"),deactivate=!0);if(deactivate){for(r.getElementsByClassName("kt-header")[0].lastElementChild.dataset.state="open",s.getElementsByClassName("kt-handlers").length&&s.getElementsByClassName("kt-handlers")[0].remove(),h=(n=s.getElementsByClassName("kt-item")).length,p=r.getElementsByClassName("kt-head"),(l=document.createElement("div")).className="kt-handlers",i=max_width=0;i<h;i++)n[i]&&n[i].classList.contains("kt-deactive")&&((c=document.createElement("div")).className="kt-handler",(o=document.createElement("div")).className="kt-handler-head",o.innerHTML=p[i].outerHTML,c.appendChild(o),(o=document.createElement("div")).className="kt-handler-body",o.innerHTML=n[i].outerHTML,c.appendChild(o),l.appendChild(c));s.firstElementChild.lastElementChild.classList.contains("kt-handle")?s.firstElementChild.lastElementChild.dataset.state="open":((n=document.createElement("span")).className="kt-handle icon-plus",n.dataset.state="open",n.onclick=changeHandler.bind(null,n),s.firstElementChild.appendChild(n)),s.appendChild(l)}else s.firstElementChild.lastElementChild.classList.contains("kt-handle")&&(s.firstElementChild.lastElementChild.dataset.state="",r.getElementsByClassName("kt-header")[0].lastElementChild.dataset.state="")}for(a=(t=r.getElementsByClassName("kt-head")).length,d=0;d<a;d++)(s=t[d]).style.minWidth=o[d]+"px",d<m?!0===s.classList.contains("kt-deactive")&&s.classList.remove("kt-deactive"):!1===s.classList.contains("kt-deactive")&&s.classList.add("kt-deactive")}function setItems(e,t){var a,s,l=e.length,n=t.template,d=t.template_type,i="";if("object"==typeof n)for(s=0;s<l;s++)a=e[s],f=a[d],i+=setTemplate(n[f],a);else for(s=0;s<l;s++)i+=setTemplate(n,e[s]);t.holder.innerHTML=i}function setNav(e,t){var a,s,l=t.count/t.limit;switch(t.navs.dataset.state=!l||l<=1?"opage":"mpage",a=Math.ceil(l),e){case-1:if(1==t.page)return;t.start=0,s=1;break;case-2:t.start<t.limit?t.start=0:(t.start-=t.limit,s=Math.ceil(t.start/t.limit)+1);break;case-3:if(a<(s=Math.ceil((t.start+t.limit)/t.limit)+1))return;t.start+=t.limit;break;case-4:if(t.start=Math.floor(l)*t.limit,s=Math.ceil(t.start/t.limit)+1,t.page==s)return;break;default:t.start=(e-1)*t.limit,s=e}t.page=s,updateTable(t)}function changeOrder(e,t,a,s){c="1"===t.dataset.order?"0":"1",s.shiftKey||(delete e.data.order,e.data.order={}),e.data.order[a]=c,updateTable(e)}function setTables(){function startsetTables(){for(var e,t=document.getElementsByClassName("kalenux-tables"),a=t.length,s=0;s<a;s++)setTable(e=t[0]),e.className="kalenux-table-holder",e.dataset.state="hidden"}function setHeader(t,a){var s,l,n,d=document.createElement("div");for(d.className="kt-header",s=(a=a.split(",")).length,l=0;l<s;l++)n=a[l],(e=document.createElement("div")).className="kt-head",e.innerHTML=n,e.onclick=changeOrder.bind(event,t,e,l),d.appendChild(e);return(e=document.createElement("div")).className="kt-head-plus icon-plus",e.onclick=openHandlers.bind(null,t,e),d.appendChild(e),d}function setTable(a){var b,c,d,e,f,g,i,n,g=a.dataset,n=g.id,b=g.type;for(b=document.createElement("div"),b.className="kalenux-table",g.before&&eval(g.before),tables[n].data={},g.data&&(tables[n].data=JSON.parse(g.data)),g.order&&(tables[n].data.order=JSON.parse(g.order)),tables[n].table=b,tables[n].start=0,g.limit?tables[n].limit=g.limit:tables[n].limit=10,tables[n].nav="true"===g.nav,tables[n].count=0,tables[n].page=1,tables[n].url=g.url,tables[n].type=g.type,tables[n].widths=[],c=document.createElement("div"),c.className="kt-top",g.header&&(h=setHeader(tables[n],g.header),h&&c.appendChild(h)),d=document.createElement("div"),d.className="kt-mid",e=document.createElement("div"),e.className="kt-bot",e.id="kt_nav",f=document.createElement("div"),f.className="kt-navs",tables[n].navs=f,tables[n].holder=d,e.appendChild(f),b.appendChild(c),b.appendChild(d),b.appendChild(e),a.appendChild(b),a=document.getElementsByClassName("table-filter"),b=a.length,i=0;i<b;i++)c=a[i],d=c.dataset,e=d.type,"search"===e?c.onkeydown=tableSearch.bind(null,tables[n]):"date"===e?$("#"+c.id).datepicker({onSelect:updateTable.bind(null,tables[n])}):c.onchange=updateTable.bind(null,tables[n]);updateTable(tables[n])}startsetTables()}function tableSearch(e,t){13==t.keyCode&&(updateTable(e),t.preventDefault())}function updateTable(table){var a,b,c,d,e,i;for(table.data.start=table.start,table.data.limit=table.limit,a=document.getElementsByClassName("table-filter"),b=a.length,i=0;i<b;i++)c=a[i],d=c.dataset,e=d.type,e="date"===e?$("#"+c.id).val():c.value,e&&(table.data[d.name]=e);var c=table.type;c=eval(c+"_api_url"),c+=table.url,postJSON(c,function(e,t){var a;1===e.result&&(t=t.b,(a=e.count)&&setOpen("kt_nav"),console.log(a),0==a?document.getElementsByClassName("kalenux-table-holder")[0].dataset.state="hidden":(document.getElementsByClassName("kalenux-table-holder")[0].dataset.state="",t.count=a=a||1,setItems(e.data,t),setWidths(t),adjustWidth(t),!0===t.nav&&setNavs(t)))},table.data,{b:table})}function setDelete(e){setPopup({dataset:{id:e.dataset.id,del_url:table_del_url},text:table_del_text,actions:[{text:"Evet",icon:"icon-yes",onclick:deleteItem},{text:"HayÄ±r",icon:"icon-no",onclick:closePopup}]})}function deleteItem(){var e=document.getElementById("popup").dataset,a={id:e.id};postJSON(e.del_url,function(e){for(t in table)updateTable(table[t]);closePopup()},a)}firer.push(function(){startKalenux(),window.onresize=adjustWidths});